Description: This lab has a “Check stock” feature that embeds the user input inside a server-side XML document that is subsequently parsed. Because you don’t control the entire XML document you can’t define a DTD to launch a classic XXE attack. To solve the lab, inject an XInclude statement to retrieve the contents of the /etc/passwd file.

Lỗi nằm ở tính năng Check stock. Và ta không thể control toàn bộ tài liệu XML do đó không thể sử dụng XXE cơ bản mà phải sử dụng XInclude để in ra nội dung của file.

![image](https://github.com/elliSzAt/XML-external-entity-XXE-injection/assets/125866921/c5155458-f2e2-4659-842d-85b3bc21908b)

Như ta thấy thì chỉ có thể tác động lên ``productId`` và ``storeId``. Có thể thành phần XML của lab này vẫn giống ở lab trước.

```
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck>
    <productId>1</productId>
    <storeId>1</storeId>
</stockCheck>
```

Một số ứng dụng nhận dữ liệu do máy khách gửi, nhúng nó ở phía máy chủ vào tài liệu XML, sau đó phân tích cú pháp tài liệu. Một ví dụ về điều này xảy ra khi dữ liệu do khách hàng gửi được đặt vào một yêu cầu SOAP phụ trợ, sau đó được xử lý bởi dịch vụ SOAP phụ trợ.

Trong tình huống này, bạn không thể thực hiện một cuộc tấn công XXE cổ điển, bởi vì bạn không kiểm soát toàn bộ tài liệu XML và do đó không thể xác định hoặc sửa đổi một phần tử DOCTYPE. Tuy nhiên, bạn có thể sử dụng XInclude để thay thế. XInclude là một phần của đặc tả XML cho phép một tài liệu XML được xây dựng từ các tài liệu con. Bạn có thể thực hiện một cuộc tấn công XInclude trong bất kỳ giá trị dữ liệu nào trong tài liệu XML, vì vậy cuộc tấn công có thể được thực hiện trong các tình huống mà bạn chỉ kiểm soát một mục dữ liệu được đặt trong tài liệu XML phía máy chủ.

Nói sơ qua về XInclude:

  - Thông thường hacker không thể control all dữ liệu XML, nhưng có thể control 1 input sẽ được đưa vào dữ liệu XML đó. Trong trường hợp này, ta không thể sử dụng external entity hay parameter entity,… Ta chỉ có thể control parameter đầu vào. Tưởng chừng như nó là an toàn với XXE nhưng không. Ta có thể sử dụng tính năng của XML là XInclude để có thể thực thi XXE với chỉ 1 parameter.
  - XInclude là 1 cách để có thể Include 1 tài liệu XML khác. Sử dụng tính năng này, ta có thể include 1 tài liệu XML có chứa external entity và leak data từ server.

Sử dụng payload sau:

```
<foo xmlns:xi="http://www.w3.org/2001/XInclude"><xi:include parse="text" href="file:///etc/passwd"/></foo>
```

![image](https://github.com/elliSzAt/XML-external-entity-XXE-injection/assets/125866921/ca19f1c8-5905-47e5-bd12-1f9ba4bd622a)

Ta đã hoàn thành lab.
